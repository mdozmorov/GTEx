---
title: "Genes best correlating with the selected gene"
output:
  html_document:
    toc: true
    # toc_float: true
    theme: united
    # theme: cerulean
    # number_sections: true
date: "`r Sys.Date()`"
author: "Mikhail Dozmorov"
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Set up the environment
library(knitr)
opts_chunk$set(cache.path='cache/', fig.path='img/', cache=F, tidy=T, fig.keep='high', echo=F, dpi=100, warnings=F, message=F, comment=NA, warning=F, results='as.is', fig.width = 10, fig.height = 6) #out.width=700, 
library(pander)
panderOptions('table.split.table', Inf)
set.seed(1)
library(dplyr)
options(stringsAsFactors = FALSE)
```

```{r libraries}
library(yarn)
library(dplyr)
library(enrichR)
```

```{r settings}
data_dir <- "/Users/mdozmorov/Documents/Data/GenomeRunner/GTEx/" # Mac
data_dir <- "F:/Data/GenomeRunner/GTEx/" # Windows
# data_dir <- "data/" # Windows temporary

fileNameIn_gtex <- paste0(data_dir, "gtex.rds")
tissue <- "Brain" #  "Adipose Tissue", "Adrenal Gland", "Blood Vessel", "Bladder", "Brain", "Breast", "Blood", "Skin", "Cervix Uteri", "Colon", "Esophagus", "Fallopian Tube", "Heart", "Kidney", "Liver", "Lung", "Salivary Gland", "Muscle", "Nerve", "Ovary", "Pancreas", "Pituitary", "Prostate", "Small Intestine", "Spleen", "Stomach", "Testis", "Thyroid", "Uterus", "Vagina"
fileNameOut_gtex <- paste0(sub(".rds", "", fileNameIn_gtex), "_", tissue, ".rda") # Where to save subsetted and normalized object
proportion_cutoff <- 0.33 # maximum proportion of missing values, if more - exclude gene
corr_type <- "pearson" # Type of correlations, may be "spearman"
corr_cutoff <- 0.2 # Cutoff for selecting best correlated genes
fdr.cutoff <- 0.1 # Cutoff for functional enrichment analysis
extended_analysis <- FALSE # Run extended (=use all EnrichR databases) analysis?
```

```{r}
library(annotables)
# Remove non-canonical chromosome names
grch38 <- grch38[ !(grepl("_", grch38$chr) | grepl("GL", grch38$chr)), ]
grch38 <- grch38[, c("ensgene", "symbol", "description")]
grch38 <- grch38[ !duplicated(grch38), ]

# A wrapper function to perform all functional enrichment analyses.
# Helper function to save non-empty results
save_res <- function(res, fileName = fileName, wb = wb, sheetName = "KEGG") {
  if (nrow(res) > 0) {
    openxlsx::addWorksheet(wb = wb, sheetName = sheetName)
    openxlsx::writeData(wb, res, sheet = sheetName)
    openxlsx::saveWorkbook(wb, fileName, overwrite = TRUE)
  }
}

# A wrapper to save the results
save_enrichr <- function(up.genes = up.genes, dn.genes = dn.genes, databases = "KEGG_2016", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb) {
  print(paste("Running", databases, "analysis", sep = " "))
  res.kegg <- enrichFullGeneList(up.genes, dn.genes, databases = databases, fdr.cutoff = fdr.cutoff)
  res.kegg$pval <- formatC(res.kegg$pval, digits = 3, format = "e")
  res.kegg$qval <- formatC(res.kegg$pval, digits = 3, format = "e")
  if (nchar(databases) > 30) databases <- paste0(substr(databases, 1, 20), "_", substr(databases, nchar(databases) - 8, nchar(databases))) # If a database is longer that 30 characters, keep first 20 and last 10 characters
  save_res(res.kegg, fileNameOut, wb = wb, sheetName = databases)
  # Pause for a few seconds
  pause_sec <- round(runif(1, min = 1, max = 10))
  Sys.sleep(pause_sec)
  return(res.kegg)
}
```

```{r load}
if (!file.exists(fileNameOut_gtex)) { # If not preprocessed file
  # load the original file
  obj <- readRDS(file = fileNameIn_gtex)
  # subset
  ind_tissue <- which(pData(obj)$SMTS == tissue)
  obj <- obj[, ind_tissue ]
  # filter
  ff <- genefilter::pOverA(p = proportion_cutoff, A = 0, na.rm = TRUE) # Should be more than 90% of non-zero values
  obj <- obj[apply(exprs(obj), 1, ff), ] 
  # normalize log2-transformed data
  exprs <- limma::normalizeQuantiles(log2(exprs(obj) + 1))
  exprs(obj) <- exprs
  # Save
  save(obj, file = fileNameOut_gtex) # Select cancers
} else {
  load(file = fileNameOut_gtex)
}
```

```{r select_genes}
# Select by gene name
# selected_genes <- c("LOC151121")
# sum(fData(obj)$hgnc_symbol %in% selected_genes)
# Or, select by Ensembl ID
selected_genes <- c("ENSG00000250658") # LOC339975
selected_genes <- c("ENSG00000204460") # LOC151121
selected_genes <- c("ENSG00000246090") # LOC100507053
sum(fData(obj)$ensembl_gene_id %in% selected_genes)
fData(obj)[ fData(obj)$ensembl_gene_id %in% selected_genes, ]
# Goal - to get index of the selected gene
ind_gene <- which(fData(obj)$ensembl_gene_id %in% selected_genes)
```

```{r prepareFile}
# File name to save all results
fileNameOut <- paste0("results/GTEx_", tissue, "_", selected_genes, ".xlsx")
unlink(fileNameOut)
wb <- openxlsx::createWorkbook(fileNameOut) # openxlsx::loadWorkbook(fileName)
```

```{r correlations}
# File name to save correlation object
fileNameOut_corr <- paste0("data/corr_", selected_genes, ".rda")

if (!file.exists(fileNameOut_corr)) { # If correlations are not precomputed
  max_corrs <- nrow(obj) # How many rows to process
  all_corrs <- vector(mode = "numeric", length = max_corrs)
  all_pvals <- vector(mode = "numeric", length = max_corrs)
  target_gene <- as.numeric(exprs(obj)[ ind_gene, ]) # The target gene to run correlation on
  exprs <- exprs(obj) # Extract expression matrix once
  for (i in 1:max_corrs) {
    cors         <- Hmisc::rcorr(target_gene, as.numeric(exprs[ i, ]), type = corr_type)
    all_corrs[i] <- cors[[1]][1, 2]
    all_pvals[i] <- cors[[3]][1, 2]
  }
  correlations <- data.frame(fData(obj)[1:max_corrs, ], corr = all_corrs, pval = all_pvals) # Assemble correlations
  correlations <- left_join(correlations, grch38, by = c("ensembl_gene_id" = "ensgene"))
  save(correlations, file = fileNameOut_corr)
} else {
  load(file = fileNameOut_corr)
}
save_res(correlations[ order(correlations$corr, decreasing = TRUE), ], fileNameOut, wb = wb, sheetName = "Correlations")
```

# Correlation analysis

## Positively correlated genes 


Genes positively correlated with the selected gene `r selected_genes` across all `r tissue` tissues. Correlation method: `r corr_type`, correlation coefficient cutoff: >`r corr_cutoff`. Legend:

- `symbol`, `description` - gene symbols/description
- `cor`, `pval` - Pearson correlation coefficient, and p-value of correlation significance

```{r}
correlations_pos <- correlations[ correlations$corr > corr_cutoff, ]
correlations_pos$corr <- signif(correlations_pos$corr)
correlations_pos$pval <- signif(correlations_pos$pval)
DT::datatable(correlations_pos[ order(correlations_pos$corr, decreasing = TRUE), ])
up.genes <- unique(correlations_pos$hgnc_symbol[ !(is.na(correlations_pos$hgnc_symbol) | correlations_pos$hgnc_symbol == "") ])
```

We have `r nrow(correlations_pos)` genes positively correlated with `r selected_genes`.

## Negatively correlated genes

```{r}
correlations_neg <- correlations[ correlations$corr < -corr_cutoff, ]
correlations_neg$corr <- signif(correlations_neg$corr)
correlations_neg$pval <- signif(correlations_neg$pval)
DT::datatable(correlations_neg[ order(correlations_neg$corr, decreasing = FALSE), ])
dn.genes <- unique(correlations_neg$hgnc_symbol[ !(is.na(correlations_neg$hgnc_symbol) | correlations_neg$hgnc_symbol == "") ])
```

We have `r nrow(correlations_neg)` genes negatively correlated with `r selected_genes`.


# Functional enrichment analysis

- Each table has enrichment results separately for up/downregulated genes. The "direction" column indicate which pathways are enriched in "UP"- or "DN"-regulated genes.

- Use the "Search" box for each table, to filter the results for "UP" or "DN" only. Search is global within the table, case insensitive.

- FDR cutoff - `r fdr.cutoff`.

## KEGG

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "KEGG_2016", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## GO_Biological_Process_2015

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "GO_Biological_Process_2015", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## GO_Molecular_Function_2015

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "GO_Molecular_Function_2015", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## GO_Cellular_Component_2015

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "GO_Cellular_Component_2015", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## WikiPathways_2016

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "WikiPathways_2016", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## BioCarta_2016

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "BioCarta_2016", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## Reactome_2016

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "Reactome_2016", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## Panther_2016

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "Panther_2016", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## TRANSFAC_and_JASPAR_PWMs

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "TRANSFAC_and_JASPAR_PWMs", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## Genome_Browser_PWMs

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "Genome_Browser_PWMs", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## ChEA_2016

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "ChEA_2016", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## ENCODE_TF_ChIP-seq_2015

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "ENCODE_TF_ChIP-seq_2015", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## ENCODE_Histone_Modifications_2015

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "ENCODE_Histone_Modifications_2015", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

## Epigenomics_Roadmap_HM_ChIP-seq

```{r}
res.kegg <- save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = "Epigenomics_Roadmap_HM_ChIP-seq", fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
DT::datatable(res.kegg)
```

<!--
## Extended analyses `r if (extended_analysis) cat("was run") else cat("was not run")`


See http://amp.pharm.mssm.edu/Enrichr/#stats for databases description

- Genes_Associated_with_NIH_Grants
- Cancer_Cell_Line_Encyclopedia
- Achilles_fitness_decrease
- Achilles_fitness_increase
- Aging_Perturbations_from_GEO_down
- Aging_Perturbations_from_GEO_up
- Allen_Brain_Atlas_down
- Allen_Brain_Atlas_up
- Chromosome_Location
- CORUM
- dbGaP
- Disease_Perturbations_from_GEO_down
- Disease_Perturbations_from_GEO_up
- Disease_Signatures_from_GEO_down_2014
- Disease_Signatures_from_GEO_up_2014
- Drug_Perturbations_from_GEO_2014
- Drug_Perturbations_from_GEO_down
- Drug_Perturbations_from_GEO_up
- DrugMatrix
- ESCAPE
- GeneSigDB
- Genome_Browser_PWMs
- GTEx_Tissue_Sample_Gene_Expression_Profiles_down
- GTEx_Tissue_Sample_Gene_Expression_Profiles_up
- HMDB_Metabolites
- HomoloGene
- Human_Gene_Atlas
- Human_Phenotype_Ontology
- HumanCyc_2015
- Humancyc_2016
- KEA_2013
- KEA_2015
- Kinase_Perturbations_from_GEO_down
- Kinase_Perturbations_from_GEO_up
- Ligand_Perturbations_from_GEO_down
- Ligand_Perturbations_from_GEO_up
- LINCS_L1000_Chem_Pert_down
- LINCS_L1000_Chem_Pert_up
- LINCS_L1000_Kinase_Perturbations_down
- LINCS_L1000_Kinase_Perturbations_up
- LINCS_L1000_Ligand_Perturbations_down
- LINCS_L1000_Ligand_Perturbations_up
- MCF7_Perturbations_from_GEO_down
- MCF7_Perturbations_from_GEO_up
- MGI_Mammalian_Phenotype_2013
- MGI_Mammalian_Phenotype_Level_3
- MGI_Mammalian_Phenotype_Level_4
- Microbe_Perturbations_from_GEO_down
- Microbe_Perturbations_from_GEO_up
- Mouse_Gene_Atlas
- MSigDB_Computational
- MSigDB_Oncogenic_Signatures
- NCI-60_Cancer_Cell_Lines
- NCI-Nature_2016
- NURSA_Human_Endogenous_Complexome
- Old_CMAP_down
- Old_CMAP_up
- OMIM_Disease
- OMIM_Expanded
- Pfam_InterPro_Domains
- Phosphatase_Substrates_from_DEPOD
- PPI_Hub_Proteins
- SILAC_Phosphoproteomics
- Single_Gene_Perturbations_from_GEO_down
- Single_Gene_Perturbations_from_GEO_up
- TargetScan_microRNA
- TF-LOF_Expression_from_GEO
- Tissue_Protein_Expression_from_Human_Proteome_Map
- Tissue_Protein_Expression_from_ProteomicsDB
- Transcription_Factor_PPIs
- Virus_Perturbations_from_GEO_down
- Virus_Perturbations_from_GEO_up
- VirusMINT



```{r}
remaining_analyses <- c("Genes_Associated_with_NIH_Grants", "Cancer_Cell_Line_Encyclopedia", "Achilles_fitness_decrease", "Achilles_fitness_increase", "Aging_Perturbations_from_GEO_down", "Aging_Perturbations_from_GEO_up", "Allen_Brain_Atlas_down", "Allen_Brain_Atlas_up", "Chromosome_Location", "CORUM", "dbGaP", "Disease_Perturbations_from_GEO_down", "Disease_Perturbations_from_GEO_up", "Disease_Signatures_from_GEO_down_2014", "Disease_Signatures_from_GEO_up_2014", "Drug_Perturbations_from_GEO_2014", "Drug_Perturbations_from_GEO_down", "Drug_Perturbations_from_GEO_up", "DrugMatrix", "ESCAPE", "GeneSigDB", "Genome_Browser_PWMs", "GTEx_Tissue_Sample_Gene_Expression_Profiles_down", "GTEx_Tissue_Sample_Gene_Expression_Profiles_up", "HMDB_Metabolites", "HomoloGene", "Human_Gene_Atlas", "Human_Phenotype_Ontology", "HumanCyc_2015", "Humancyc_2016", "KEA_2013", "KEA_2015", "Kinase_Perturbations_from_GEO_down", "Kinase_Perturbations_from_GEO_up", "Ligand_Perturbations_from_GEO_down", "Ligand_Perturbations_from_GEO_up", "LINCS_L1000_Chem_Pert_down", "LINCS_L1000_Chem_Pert_up", "LINCS_L1000_Kinase_Perturbations_down", "LINCS_L1000_Kinase_Perturbations_up", "LINCS_L1000_Ligand_Perturbations_down", "LINCS_L1000_Ligand_Perturbations_up", "MCF7_Perturbations_from_GEO_down", "MCF7_Perturbations_from_GEO_up", "MGI_Mammalian_Phenotype_2013", "MGI_Mammalian_Phenotype_Level_3", "MGI_Mammalian_Phenotype_Level_4", "Microbe_Perturbations_from_GEO_down", "Microbe_Perturbations_from_GEO_up", "Mouse_Gene_Atlas", "MSigDB_Computational", "MSigDB_Oncogenic_Signatures", "NCI-60_Cancer_Cell_Lines", "NCI-Nature_2016", "NURSA_Human_Endogenous_Complexome", "Old_CMAP_down", "Old_CMAP_up", "OMIM_Disease", "OMIM_Expanded", "Pfam_InterPro_Domains", "Phosphatase_Substrates_from_DEPOD", "PPI_Hub_Proteins", "SILAC_Phosphoproteomics", "Single_Gene_Perturbations_from_GEO_down", "Single_Gene_Perturbations_from_GEO_up", "TargetScan_microRNA", "TF-LOF_Expression_from_GEO", "Tissue_Protein_Expression_from_Human_Proteome_Map", "Tissue_Protein_Expression_from_ProteomicsDB", "Transcription_Factor_PPIs", "Virus_Perturbations_from_GEO_down", "Virus_Perturbations_from_GEO_up", "VirusMINT")

for (i in remaining_analyses) {
  save_enrichr(up.genes = up.genes, dn.genes = dn.genes, databases = i, fdr.cutoff = fdr.cutoff, fileNameOut = fileNameOut, wb = wb)
}
```
-->


